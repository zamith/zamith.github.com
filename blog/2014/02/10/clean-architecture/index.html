
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Clean Architecture - Crazy Little Hacks</title>
  <meta name="author" content="Zamith">

  
  <meta name="description" content="One of the hottest topics of the moment in the rails community is application
design or architecture. There is an obsession (a good one, I think) &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://zamith.github.io/blog/2014/02/10/clean-architecture">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/CrazyLittleHacks" rel="alternate" title="Crazy Little Hacks" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26971772-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Crazy Little Hacks</a></h1>
  
    <h2>Some little hacks and random thoughts on what interests me at the moment in the area of computer science.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/CrazyLittleHacks" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://www.duckduckgo.com/" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:zamith.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Clean Architecture</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-10T16:48:00+00:00" pubdate data-updated="true">Feb 10<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>One of the hottest topics of the moment in the rails community is application
design or architecture. There is an obsession (a good one, I think) with clean,
decoupled code, that is easy to maintain and extend. This has led to things such
as presenters, service objects, to some extent even rails concerns.</p>

<p>This is all fine and dandy, but I believe that in order to get closer to that
utopic dream of the perfect system, more drastic and profound changes must
happen. We need an architectural change, that shakes the foundations how we
approach the writing and thought process of a rails application. To this, Uncle
Bob has called the <strong>Clean Architecture</strong>.</p>

<p>The main igniters of this idea and therefore this article are a
<a href="http://www.youtube.com/watch?v=WpkDN78P884">talk</a> and an
<a href="http://blog.8thlight.com/uncle-bob/2012/08/13/the-clean-architecture.html">article</a>
by Uncle Bob Martin, but a lot has been written and spoken on the subject by a
lot of different people and you can find the links I find more relevant on the
bottom. They provide a good (mostly) theoretical overview of the problem and
solutions, whereas this post aims at proving a very concrete solution with code
samples in Ruby and Ruby on Rails, which is something I could not find anywhere.</p>

<h1>The Basics</h1>

<p>For those of you who don&#8217;t have the time to read the links, just want to brush
off on some of the basic concepts or for the sake of us being able to
communicate in the same vocabulary, let&#8217;s go ahead and define those concepts.</p>

<p>First off here&#8217;s a high level view of the clean architecture according to Uncle Bob:</p>

<p><img src="http://blog.8thlight.com/uncle-bob/images/2012-08-13-the-clean-architecture/CleanArchitecture.jpg" alt="clean arch" /></p>

<p>As you can see there are different layers in the application, going inside out,
the first two are the core of the app, where all the business rules and objects
live. The other two are the &#8220;details&#8221;, the delivery mechanisms (in our case it
will be Ruby on Rails), the databases (in our case postgresql), etc&#8230;</p>

<h3>Entities</h3>

<p>Entities are business objects, functions or data structures, that are
responsible for all the <strong>non</strong> application specific business rules.</p>

<p>This means that if you have multiple applications that share the same domain
(business) objects, the entities should not need to change in order to be usable
by all of them.</p>

<h3>Interactors or Use Cases</h3>

<p>Interactors represent the layer for application specific business rules.</p>

<p>This is where most of the magic happens, they control the entire flow of the
application, using entities, but never changing them.</p>

<p>They should not, however, be affected by changes to the UI, whichever they may be.</p>

<h3>Boundaries or Adapters</h3>

<p>A boundary is the interface that translates information from the outside into
the format the application uses, as well as translating it back when the
information is going out.</p>

<p>These boundaries may not be explicit, so much as they are logical or conceptual.
In any case, they are there and you should be aware of it.</p>

<h3>The Dependency Rule</h3>

<p>This is the single most important concept, and you must  always take it into consideration.</p>

<p>The dependency rule states that <em>source code dependencies can only point inward</em>.</p>

<p>There&#8217;s a generalization of the rule that applies to any application, <em>source
code dependencies can only point in one direction</em>.</p>

<h1>Applying it to the Real World™</h1>

<p>By now you should at least know why such an architecture is important, and the
main characters that come into play.</p>

<p>But, as I&#8217;ve said before, applying all of this into a real case scenario is what
you probably don&#8217;t know and/or are curious about.</p>

<h3>Our approach</h3>

<p>We have to start somewhere, and we want to start on the right path, the best way
I know how to do that is through a use-case &amp; test driven approach.</p>

<p>I like this approach for two reasons:</p>

<ol>
<li>We need tests to guide us and to provide confidence in the code base</li>
<li>Use-cases don’t let us stray from what brings value to the business</li>
</ol>


<p>I&#8217;m not going to digress a lot into why TDD is awesome and you should do it,
since there are a lot of resources out there on the subject. I will say that
we&#8217;ll mostly be following <a href="http://vimeo.com/68375232">Ian Cooper&#8217;s ideas on
testing</a>, for which the gist is <em>the trigger for a
new test should be a new use case, not a new class or method</em>.</p>

<p>As for use cases, you can read <a href="http://www.amazon.com/Writing-Effective-Cases-Alistair-Cockburn/dp/0201702258">Alistair Cockburn&#8217;s lovely
book</a>
on the subject. But they should look something like this:</p>

<p><img src="/images/use-case.png" alt="use case" /></p>

<p>Notice that we have a main path and an alternative, which can also represent
what to do in case of error. Also, there is no reference to anything related to
the web, the use case level should be delivery mechanism agnostic. In other
words, it must work the same way regardless of being used on the web, desktop or
CLI.</p>

<h3>The test</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">context</span> <span class="s2">&quot;the company does not exist&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;creates a member&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="n">adder</span> <span class="o">=</span> <span class="ss">Coworkers</span><span class="p">:</span><span class="ss">:CoworkerAdder</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="ss">params</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">space</span><span class="p">:</span> <span class="n">default_space</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expect</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">adder</span><span class="o">.</span><span class="n">add</span>
</span><span class='line'>    <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">{</span><span class="n">member_repo</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">size</span><span class="p">}</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we have a test for the behaviour we expect, we just need to let it guide us.</p>

<p><em>Side note: This test was not written all at once, I followed the <a href="http://butunclebob.com/ArticleS.UncleBob.TheThreeRulesOfTdd">three rules
of TDD</a> to get
here.</em></p>

<h3>The interactor</h3>

<p>The code to make this test pass (minus the private methods) is as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CoworkerAdder</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="ss">params</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span> <span class="ss">space</span><span class="p">:</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@member_repo</span> <span class="o">=</span> <span class="no">Repository</span><span class="o">.</span><span class="n">for</span><span class="p">(</span><span class="ss">:member</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@company_repo</span> <span class="o">=</span> <span class="no">Repository</span><span class="o">.</span><span class="n">for</span><span class="p">(</span><span class="ss">:company</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@params</span> <span class="o">=</span> <span class="n">params</span>
</span><span class='line'>    <span class="vi">@space</span> <span class="o">=</span> <span class="n">space</span>
</span><span class='line'>    <span class="vi">@member</span> <span class="o">=</span> <span class="no">Member</span><span class="o">.</span><span class="n">new</span> <span class="n">member_params</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">add</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">member</span><span class="o">.</span><span class="n">valid?</span>
</span><span class='line'>      <span class="n">member</span><span class="o">.</span><span class="n">company_id</span> <span class="o">=</span> <span class="n">company</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>      <span class="n">member</span><span class="o">.</span><span class="n">space_id</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>      <span class="n">member_repo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">member</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<h1>The Interactor - step by step</h1>

<p>There are a lot of interesting bits of code in our interactor, and a lot of
decisions that were made. Let&#8217;s take a closer look at each of them.</p>

<h2>Repositories (Gateways)</h2>

<p>In order to abstract the persistence mechanism I decided to use the <a href="http://msdn.microsoft.com/en-us/library/ff649690.aspx">Repository
Pattern</a>, in which we
have repositories for each type of persistence mechanism we want to use and that
can be used interchangeably.</p>

<p>Sounds a lot like an interface? Well, it is, kind of&#8230; In Ruby we don&#8217;t have
interfaces, we just go ahead an use what we call a duck type.</p>

<p>Here&#8217;s an example of an in memory repository:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Repositories</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Members</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Memory</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>        <span class="vi">@members</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>        <span class="vi">@next_id</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span class='line'>        <span class="n">member</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="vi">@next_id</span>
</span><span class='line'>        <span class="vi">@members</span><span class="o">[</span><span class="vi">@next_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">member</span>
</span><span class='line'>        <span class="vi">@next_id</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">member</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">all</span>
</span><span class='line'>        <span class="n">members</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">first</span>
</span><span class='line'>        <span class="n">first_key</span> <span class="o">=</span> <span class="n">members</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>        <span class="n">members</span><span class="o">[</span><span class="n">first_key</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">last</span>
</span><span class='line'>        <span class="n">last_key</span> <span class="o">=</span> <span class="n">members</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>        <span class="n">members</span><span class="o">[</span><span class="n">last_key</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="kp">private</span>
</span><span class='line'>      <span class="kp">attr_reader</span> <span class="ss">:members</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>What&#8217;s really relevant here is the object&#8217;s public API, it&#8217;s interface, the
<code>save(member)</code>, <code>all</code>, <code>first</code> and <code>last</code> methods, since they&#8217;re what defines a
valid repository for a member.</p>

<h3>The Repo Boss</h3>

<p>Someone, somewhere needs to know which repository to use for each entity or use
case (repositories do not need to exists in a 1-1 relation with entities, even
though most of the time they do). That someone is a very simple class I call
<code>Repository</code>, which tracks the registration of repositories:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Repository</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">repo</span><span class="p">)</span>
</span><span class='line'>    <span class="n">repositories</span><span class="o">[</span><span class="n">type</span><span class="o">]</span> <span class="o">=</span> <span class="n">repo</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">for</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
</span><span class='line'>    <span class="n">repositories</span><span class="o">[</span><span class="n">type</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">repositories</span>
</span><span class='line'>    <span class="vi">@_repos</span> <span class="o">||=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you might have guessed, we then need to register the repositories we want.
That is very simple and very easy to hide behind some sort of configuration, but
here&#8217;s how it&#8217;s done:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;repository&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;repositories/members/memory&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;repositories/companies/memory&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Repository</span><span class="o">.</span><span class="n">register</span> <span class="ss">:company</span><span class="p">,</span> <span class="ss">Repositories</span><span class="p">:</span><span class="ss">:Companies</span><span class="o">::</span><span class="no">Memory</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'><span class="no">Repository</span><span class="o">.</span><span class="n">register</span> <span class="ss">:member</span><span class="p">,</span> <span class="ss">Repositories</span><span class="p">:</span><span class="ss">:Members</span><span class="o">::</span><span class="no">Memory</span><span class="o">.</span><span class="n">new</span>
</span></code></pre></td></tr></table></div></figure>


<p>After all this setup is complete, you can access repositories the way it is
shown in lines 3 and 4 of the interactor.</p>

<h2>Member Entity</h2>

<p>Entities should have a bunch of attributes and some methods that operate on
them, that enforce non app specific business rules.</p>

<p>A simple approach to it could be this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Member</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:company_id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span>
</span><span class='line'>                <span class="ss">:phone_no</span><span class="p">,</span> <span class="ss">:boss</span><span class="p">,</span> <span class="ss">:observations</span><span class="p">,</span>
</span><span class='line'>                <span class="ss">:space_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="ss">:updated_at</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>    <span class="n">attrs</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_value</span><span class="o">|</span>
</span><span class='line'>      <span class="n">public_send</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">,</span> <span class="n">attr_value</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>There might be ways of doing this that are more elegant or clever, you could,
for instance, extract common attributes such as <code>id</code>, <code>created_at</code> and
<code>updated_at</code> (or you could not even store them here, if you feel they are to
&#8220;railsy&#8221;). For now this approach will suffice, though.</p>

<h2>Validations</h2>

<p>On line 10 of the interactor you can see the method <code>valid?</code> being called on the
member entity. The easiest way I could think of to implement validations was
this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">valid?</span>
</span><span class='line'>  <span class="nb">name</span> <span class="o">&amp;&amp;</span> <span class="n">email</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">errors</span>
</span><span class='line'>  <span class="n">error_messages</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">error_messages</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;missing name&quot;</span> <span class="k">unless</span> <span class="nb">name</span>
</span><span class='line'>  <span class="n">error_messages</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;missing email&quot;</span> <span class="k">unless</span> <span class="n">email</span>
</span><span class='line'>  <span class="no">ValidationErrors</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">error_messages</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>That needs a tiny wrapper to be rails compliant, to which I called <code>ValidationErrors</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ValidationErrors</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">error_messages</span> <span class="o">=</span> <span class="o">[]</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@error_messages</span> <span class="o">=</span> <span class="n">error_messages</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">full_messages</span>
</span><span class='line'>    <span class="vi">@error_messages</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">size</span>
</span><span class='line'>    <span class="vi">@error_messages</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you have no problems with including <code>ActiveModel</code>, you can add it as a gem
and do simply this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Member</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">ActiveModel</span><span class="p">:</span><span class="ss">:Validations</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">validates_presence_of</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As with any good engineering problem, there is no correct answer. There are
trade offs in both solutions, one may take longer to implement, but is small,
the other has everything you need and probably a bunch of other stuff as well.
Pick your poison.</p>

<h3>Database dependent validations</h3>

<p>What about validations that depend on the database, such as validating
uniqueness, you might ask. The easier way would be to add that validation on the
repository, but that would spread business rules for an entity across multiple
files and we don&#8217;t want that.</p>

<p>The solution we came up with is to have a generic <code>unique?</code> method on the
repository and calling in from the entity:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">valid?</span>
</span><span class='line'>  <span class="k">super</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>  <span class="n">repo</span><span class="o">.</span><span class="n">unique?</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">:name</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The implementation of the <code>unique?</code> method for the in memory repository is as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">unique?</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@members</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">none?</span> <span class="k">do</span> <span class="o">|</span><span class="n">member</span><span class="o">|</span>
</span><span class='line'>    <span class="n">object</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">member</span><span class="o">.</span><span class="n">id</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="n">member</span><span class="o">.</span><span class="n">public_send</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span> <span class="o">==</span> <span class="n">object</span><span class="o">.</span><span class="n">public_send</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Crossing Boundaries</h2>

<p>A very important part of this whole architecture is crossing layer boundaries,
especially the boundary that separates the application from the delivery
mechanism. You want to make sure not to pass entities around, since they come
with a bunch of business rules attached, instead you should pass value objects,
or plain data structures.</p>

<p>I prefer to pass data structures, but have the serialization from entity to data
abstracted on a method called <code>value</code>, which allows for the interactor to do
what it is doing on line 14:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">member_repo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">member</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
</span></code></pre></td></tr></table></div></figure>


<p>What does that <code>value</code> do, you might ask. It simply calls a serializer.</p>

<h2>Serializers</h2>

<p>The value of an entity can be defined as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">value</span>
</span><span class='line'>  <span class="ss">Serializers</span><span class="p">:</span><span class="ss">:Raw</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">serialize</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It takes an object (in this case an entity), and serializes it&#8217;s attributes,
which, by default, it assumes come from an <code>attributes</code> method. The <code>serialize</code>
method can handle both an hash with all the attributes, in which case it just
returns it, or an array with just their names, from where it can create the hash
with the names pointing to the values.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="n">attrs_method</span><span class="p">:</span> <span class="ss">:attributes</span><span class="p">)</span>
</span><span class='line'>  <span class="n">attributes</span> <span class="o">=</span> <span class="n">object</span><span class="o">.</span><span class="n">public_send</span><span class="p">(</span><span class="n">attrs_method</span><span class="p">)</span>
</span><span class='line'>  <span class="n">get_real_attributes_from</span> <span class="n">attributes</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ActiveRecord Repository</h2>

<p>We&#8217;ve already talked about repositories and that they are duck types for a
gateway&#8217;s logical interface, you even saw an implementation in memory. But since
a very common pattern is to use Rails with ActiveRecord, I feel like I should
show how an AR implementation looks like.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;active_record&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Repositories</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Members</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">ActiveRecord</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">last</span>
</span><span class='line'>        <span class="o">::</span><span class="no">Member</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Member</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">class</span> <span class="nc">Member</span> <span class="o">&lt;</span> <span class="o">::</span><span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">value</span>
</span><span class='line'>          <span class="ss">Serializers</span><span class="p">:</span><span class="ss">:Raw</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">serialize</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are a few things of note here. One of the most obvious is that we define
the &#8220;model&#8221;, i.e. the class that inherits from AR::Base, as an inner class of
the repository. We do this because we don&#8217;t (and shouldn&#8217;t) need to use it
anywhere else, in fact, all references to AR should be encapsulated by the AR
repository.</p>

<p>This leads us to the next thing of note, the fact that we do not return nor an
AR object, nor an AR relation. The interactor (which will be calling this) only
knows how to deal with entities, so we get the value from the AR object, using a
serializer, and wrap it in an entity. All references to AR are gone.</p>

<h1>Connecting with Rails</h1>

<p>Now we have a working application (hopefully), we just need a way to deliver it
to our clients. We can do that using a CLI, web app, desktop app, REST API, or
any other way we so choose. As an example I chose to deliver it as a Rails app.</p>

<p>There are basically two steps in making this work with a Rails app:</p>

<ol>
<li>Deploy our core application as a gem</li>
<li>Require, configure and use it from the rails app</li>
</ol>


<h2>The gem</h2>

<p>I&#8217;ll not get into details on how to create gem, as that goes way beyond the
scope of this article which is already extensive, there are just a few &#8220;tips&#8221; to
make it easier to use.</p>

<p>A good way to make your gem painless to use is to autoload most of the stuff
when it is required. So your main file should look somewhat like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;cohive/core/version&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">autoload</span> <span class="ss">:Repository</span><span class="p">,</span> <span class="s2">&quot;repository&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Coworkers</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:Company</span><span class="p">,</span> <span class="s2">&quot;cohive/core/coworkers/entities/company&quot;</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:Member</span><span class="p">,</span> <span class="s2">&quot;cohive/core/coworkers/entities/member&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:CoworkerAdder</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;cohive/core/coworkers/interactors/coworker_adder&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Serializers</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:Raw</span><span class="p">,</span> <span class="s2">&quot;serializers/raw&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Another must have for a gem is to be configurable, I do it like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Cohive</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Core</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">configure</span>
</span><span class='line'>      <span class="vi">@repository_config</span> <span class="o">=</span> <span class="no">RepositoryConfig</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="k">yield</span> <span class="nb">self</span>
</span><span class='line'>      <span class="n">post_config</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">repository</span><span class="o">=</span><span class="p">(</span><span class="n">repo_type</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@repository_config</span><span class="o">.</span><span class="n">default_repo_type</span> <span class="o">=</span> <span class="n">repo_type</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">repository</span>
</span><span class='line'>      <span class="vi">@repository_config</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">post_config</span>
</span><span class='line'>      <span class="vi">@repository_config</span><span class="o">.</span><span class="n">load_repos</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this configuration options I allow the delivery mechanism to choose which
repository to use for each of the repositories that are available.</p>

<h2>The Rails app</h2>

<p>Using the gem in the Rails app is even simpler, you just include it on the Gemfile:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;cohive-core&#39;</span><span class="p">,</span> <span class="ss">path</span><span class="p">:</span> <span class="s2">&quot;../cohive-core&quot;</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>Require and configure it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;cohive/core&#39;</span>
</span><span class='line'><span class="ss">Cohive</span><span class="p">:</span><span class="ss">:Core</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">repository</span> <span class="o">=</span> <span class="ss">:active_record</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And finally, use it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>  <span class="n">adder</span> <span class="o">=</span> <span class="ss">Coworkers</span><span class="p">:</span><span class="ss">:CoworkerAdder</span><span class="o">.</span><span class="n">new</span> <span class="ss">params</span><span class="p">:</span> <span class="n">member_params</span><span class="p">,</span>
</span><span class='line'>                                       <span class="ss">space</span><span class="p">:</span> <span class="n">current_space</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">adder</span><span class="o">.</span><span class="n">add</span>
</span><span class='line'>    <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;coworkers.member.flash.added_success&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As simple as that.</p>

<h1>Conclusion</h1>

<p>I truly believe this is a great way to build applications, and even though some
of my solutions might have room for improvement, the overall architecture and
underlying ideas are very mature and should definitely be taken into
consideration.</p>

<p>Here&#8217;s a recap of the main ideas covered in this article:</p>

<ul>
<li>The application should not depend on the delivery mechanism or database, those are details</li>
<li>The application&#8217;s functionality should be driven by use cases</li>
<li>The application&#8217;s design should be driven by tests</li>
</ul>


<p>Everything that follows is a consequence of this.</p>

<p>A nice side effect of using this architecture is that there is no need to load
entire frameworks such as rails, or using a real database to run your unit tests
(you might want to do integration and system tests, but that&#8217;s for another day)
which means they are fast.</p>

<p>Here&#8217;s the tests for the service that does the same as the interactor, but from the rails app:</p>

<p><img src="/images/rails-tests.png" alt="rails tests" /></p>

<p>Notice that it takes 3.96s to run the tests. Now for the interactor with the clean architecture:</p>

<p><img src="/images/clean-tests.png" alt="clean tests" /></p>

<p>Notice that I&#8217;ve added more tests and yet it takes only 0.54s to run them all.
It&#8217;s an 86.4% improvement in testing time! When doing TDD you should be running
your test every 30s or so, that&#8217;s a gain of approximately 54 minutes per work
day.</p>

<h2>Relevant Links</h2>

<ul>
<li><a href="http://cleancoders.com/codecast/clean-code-episode-7/show">Architecture, Use Cases and High Level Design</a> by Uncle Bob Martin</li>
<li><a href="http://www.youtube.com/watch?v=yTkzNHF6rMs">Boudaries</a> by Gary Bernhardt</li>
<li><a href="https://groups.google.com/forum/#!forum/clean-code-discussion">Clean Coders Discussion Board</a></li>
<li><a href="http://alistair.cockburn.us/Hexagonal+architecture">Ports and Adapters</a> by Alistair Cockburn</li>
<li><a href="http://victorsavkin.com/post/42542190528/hexagonal-architecture-for-rails-developers">Hexagonal Architecture for Rails Developers</a> by Victor Savkin</li>
<li><a href="http://www.youtube.com/watch?v=CGN4RFkhH2M">Hexagonal Rails</a> by Matt Wynne</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Zamith</span></span>

      








  


<time datetime="2014-02-10T16:48:00+00:00" pubdate data-updated="true">Feb 10<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/architecture/'>architecture</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://zamith.github.io/blog/2014/02/10/clean-architecture/" data-via="zamith" data-counturl="http://zamith.github.io/blog/2014/02/10/clean-architecture/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/12/02/random-tip-1/" title="Previous Post: Random Tip: Diffing like a pro">&laquo; Random Tip: Diffing like a pro</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/02/11/testing-js-with-rspec-features/" title="Next Post: Testing JS with RSpec features">Testing JS with RSpec features &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section id="about">
  <h1>About Me</h1>
  <img id="me" src="/images/me.jpg" alt="Zamith">

  <p>I'm the Co-Founder of <a href="http://www.groupbuddies.com/">Group Buddies</a></p>

  <p>I live in Braga, Portugal. I'm a geek, clean code lover and bballer.</p>

  <p>All opinions are my own and don't necessarily reflect those of my employer.</p>

  <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a>

  <a href="mailto:luis@zamith.pt"><img id="pair-with-me" src="http://pairprogramwith.me/badge.png" alt="Pair program with me!" ></a>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/11/26/thoughts-on-experiments/">Thoughts on trying new things</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/05/supercharging-your-git/">Supercharging your git</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/22/vim-project-specific-config/">Vim project specific configs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/10/rust-vs-ruby/">Rust vs Ruby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/02/autoreload-with-vim/">Autoreload with Vim</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/zamith">@zamith</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'zamith',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("zamith", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/zamith" class="twitter-follow-button" data-show-count="false">Follow @zamith</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Zamith -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'crazylittlehacks';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://zamith.github.io/blog/2014/02/10/clean-architecture/';
        var disqus_url = 'http://zamith.github.io/blog/2014/02/10/clean-architecture/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
